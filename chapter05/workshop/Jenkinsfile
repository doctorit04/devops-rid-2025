pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'my-static-site-nginx'
        DOCKER_TAG = 'latest'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                git url: 'https://gitlab.com/your-repo/my-static-site.git', branch: 'main', credentialsId: 'gitlab-credentials'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
            }
        }

        stage('Stop Old Container') {
            steps {
                echo 'Stopping old container if exists...'
                sh '''
                    if docker ps -a --format '{{.Names}}' | grep -Eq "^static-nginx\$"; then
                        docker stop static-nginx
                        docker rm static-nginx
                    else
                        echo "No running container to stop."
                    fi
                '''
            }
        }

        stage('Run New Container') {
            steps {
                echo 'Starting new container...'
                sh "docker run -d --name static-nginx -p 80:80 ${DOCKER_IMAGE}:${DOCKER_TAG}"
            }
        }
    }

    post {
        success {
            echo 'Deploy static website successfully!'
        }
        failure {
            echo 'Deploy failed! Check logs.'
        }
    }
}
